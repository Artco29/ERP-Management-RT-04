<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Management RT 04</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #3498db; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { background: var(--primary-color); min-height: 100vh; color: white; }
        .nav-link { color: rgba(255,255,255,0.8); margin: 5px 0; }
        .nav-link:hover, .nav-link.active { background: var(--accent-color); color: white; border-radius: 5px; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 10px; }
        .status-paid { color: green; font-weight: bold; }
        .status-unpaid { color: red; font-weight: bold; }
        @media (max-width: 768px) { .sidebar { min-height: auto; } }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse p-3" id="sidebarMenu">
            <h4 class="text-center mb-4">RT 04 Digital</h4>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#" onclick="showSection('dashboard')">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('warga')">Data Warga</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('ipl')">Pembayaran & Status IPL</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('kas')">Pengeluaran Kas</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('komplain')">Komplain</a></li>
            </ul>
            <hr>
            <button class="btn btn-sm btn-outline-light w-100" onclick="saveDataToCloud()">Simpan Permanen (Cloud)</button>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            
            <section id="sec-dashboard">
                <h2 class="mb-4">Ringkasan RT 04</h2>
                <div class="row g-3">
                    <div class="col-md-6"><div class="card p-3"><h5>Statistik Warga</h5><canvas id="chartWarga"></canvas></div></div>
                    <div class="col-md-6"><div class="card p-3"><h5>Keuangan IPL vs Kas</h5><canvas id="chartKeuangan"></canvas></div></div>
                </div>
            </section>

            <section id="sec-warga" class="d-none">
                <div class="d-flex justify-content-between mb-3 align-items-center">
                    <h3>Data Warga</h3>
                    <div>
                        <input type="file" id="importWarga" hidden onchange="importExcel(event)">
                        <button class="btn btn-success btn-sm" onclick="document.getElementById('importWarga').click()">Impor Excel</button>
                    </div>
                </div>
                <div class="card p-3">
                    <form id="formWarga" class="row g-2 mb-3">
                        <div class="col-md-3"><input type="text" id="wNama" class="form-control" placeholder="Nama" required></div>
                        <div class="col-md-3"><input type="text" id="wAlamat" class="form-control" placeholder="Alamat" required></div>
                        <div class="col-md-2">
                            <select id="wStatus" class="form-select">
                                <option value="Tetap">Tetap</option>
                                <option value="Kontrak">Kontrak</option>
                            </select>
                        </div>
                        <div class="col-md-2"><input type="text" id="wTelp" class="form-control" placeholder="No Telp"></div>
                        <div class="col-md-2"><button class="btn btn-primary w-100" type="submit">Tambah</button></div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabWarga">
                            <thead><tr><th>Nama</th><th>Alamat</th><th>Status</th><th>Kontak</th><th>Aksi</th></tr></thead>
                            <tbody id="bodyWarga"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-ipl" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h3>Status & Pembayaran IPL</h3>
                    <button class="btn btn-danger btn-sm" onclick="exportPDF('tabIPL', 'Laporan_IPL')">Export PDF</button>
                </div>
                <div class="card p-3 mb-4">
                    <form id="formIPL" class="row g-2 mb-3">
                        <div class="col-md-3"><select id="iNama" class="form-select"></select></div>
                        <div class="col-md-2"><input type="number" id="iBiaya" class="form-control" placeholder="Biaya (Rp)"></div>
                        <div class="col-md-3"><input type="text" id="iKet" class="form-control" placeholder="Keterangan (Bulan)"></div>
                        <div class="col-md-2">
                            <select id="iStatus" class="form-select">
                                <option value="Lunas">Lunas</option>
                                <option value="Belum Bayar">Belum Bayar</option>
                            </select>
                        </div>
                        <div class="col-md-2"><button class="btn btn-primary w-100" type="submit">Input</button></div>
                    </form>
                    <div class="table-responsive">
                        <table class="table" id="tabIPL">
                            <thead><tr><th>Nama</th><th>Alamat</th><th>Biaya</th><th>Ket</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody id="bodyIPL"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-kas" class="d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h3>Pengeluaran Kas</h3>
                    <button class="btn btn-success btn-sm" onclick="exportExcel('tabKas', 'Rekap_Kas_Bulanan')">Rekap Excel</button>
                </div>
                <div class="card p-3">
                    <form id="formKas" class="row g-2 mb-3">
                        <div class="col-md-3">
                            <select id="kJenis" class="form-select">
                                <option value="Lampu">Perbaikan Lampu</option>
                                <option value="CCTV">Perbaikan CCTV</option>
                                <option value="Token">Token Listrik</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="col-md-3"><input type="number" id="kJumlah" class="form-control" placeholder="Jumlah (Rp)"></div>
                        <div class="col-md-4"><input type="text" id="kKet" class="form-control" placeholder="Keterangan Detail"></div>
                        <div class="col-md-2"><button class="btn btn-warning w-100" type="submit">Catat</button></div>
                    </form>
                    <div class="table-responsive">
                        <table class="table" id="tabKas">
                            <thead><tr><th>Kategori</th><th>Biaya</th><th>Keterangan</th><th>Tanggal</th><th>Aksi</th></tr></thead>
                            <tbody id="bodyKas"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-komplain" class="d-none">
                <h3>Komplain Warga</h3>
                <div class="card p-3">
                    <form id="formKomplain" class="row g-2 mb-3">
                        <div class="col-md-3"><input type="text" id="cNama" class="form-control" placeholder="Nama Pengadu"></div>
                        <div class="col-md-7"><input type="text" id="cIsi" class="form-control" placeholder="Isi Komplain"></div>
                        <div class="col-md-2"><button class="btn btn-dark w-100" type="submit">Kirim</button></div>
                    </form>
                    <div id="listKomplain"></div>
                </div>
            </section>

        </main>
    </div>
</div>

<script>
    // Database Local & Config Cloud (Ganti URL dengan npoint.io Anda setelah Create)
    let db = { warga: [], ipl: [], kas: [], komplain: [] };
    const JSON_BIN_URL = 'https://api.npoint.io/8bcc4592ad9f2d176e14'; // Contoh ID dummy

    // Inisialisasi
    window.onload = async () => {
        const localData = localStorage.getItem('erp_rt04');
        if(localData) db = JSON.parse(localData);
        renderAll();
        initCharts();
    };

    function showSection(id) {
        document.querySelectorAll('main section').forEach(s => s.classList.add('d-none'));
        document.getElementById('sec-' + id).classList.remove('d-none');
        updateIPLDropdown();
    }

    // --- LOGIC DATA WARGA ---
    document.getElementById('formWarga').onsubmit = (e) => {
        e.preventDefault();
        db.warga.push({
            id: Date.now(),
            nama: document.getElementById('wNama').value,
            alamat: document.getElementById('wAlamat').value,
            status: document.getElementById('wStatus').value,
            telp: document.getElementById('wTelp').value
        });
        saveLocal();
        renderWarga();
        e.target.reset();
    };

    function renderWarga() {
        const body = document.getElementById('bodyWarga');
        body.innerHTML = db.warga.map((w, index) => `
            <tr>
                <td>${w.nama}</td><td>${w.alamat}</td><td>${w.status}</td><td>${w.telp}</td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteData('warga', ${index})">Hapus</button></td>
            </tr>
        `).join('');
    }

    // --- LOGIC IPL ---
    function updateIPLDropdown() {
        const select = document.getElementById('iNama');
        select.innerHTML = db.warga.map(w => `<option value="${w.nama}">${w.nama} (${w.alamat})</option>`).join('');
    }

    document.getElementById('formIPL').onsubmit = (e) => {
        e.preventDefault();
        const nama = document.getElementById('iNama').value;
        const warga = db.warga.find(w => w.nama === nama);
        db.ipl.push({
            nama: nama,
            alamat: warga ? warga.alamat : '-',
            biaya: document.getElementById('iBiaya').value,
            ket: document.getElementById('iKet').value,
            status: document.getElementById('iStatus').value
        });
        saveLocal();
        renderIPL();
        e.target.reset();
    };

    function renderIPL() {
        const body = document.getElementById('bodyIPL');
        body.innerHTML = db.ipl.map((i, idx) => `
            <tr>
                <td>${i.nama}</td><td>${i.alamat}</td><td>Rp ${parseInt(i.biaya).toLocaleString()}</td><td>${i.ket}</td>
                <td class="${i.status === 'Lunas' ? 'status-paid' : 'status-unpaid'}">${i.status}</td>
                <td><button class="btn btn-outline-danger btn-sm" onclick="deleteData('ipl', ${idx})">x</button></td>
            </tr>
        `).join('');
    }

    // --- LOGIC KAS ---
    document.getElementById('formKas').onsubmit = (e) => {
        e.preventDefault();
        db.kas.push({
            jenis: document.getElementById('kJenis').value,
            jumlah: document.getElementById('kJumlah').value,
            ket: document.getElementById('kKet').value,
            tgl: new Date().toLocaleDateString('id-ID')
        });
        saveLocal();
        renderKas();
        e.target.reset();
    };

    function renderKas() {
        document.getElementById('bodyKas').innerHTML = db.kas.map((k, idx) => `
            <tr><td>${k.jenis}</td><td>Rp ${parseInt(k.jumlah).toLocaleString()}</td><td>${k.ket}</td><td>${k.tgl}</td>
            <td><button class="btn btn-outline-danger btn-sm" onclick="deleteData('kas', ${idx})">x</button></td></tr>
        `).join('');
    }

    // --- UTILITIES ---
    function deleteData(key, index) {
        if(confirm('Hapus data ini?')) {
            db[key].splice(index, 1);
            saveLocal();
            renderAll();
        }
    }

    function saveLocal() {
        localStorage.setItem('erp_rt04', JSON.stringify(db));
        updateCharts();
    }

    async function saveDataToCloud() {
        alert("Mengirim data ke npoint.io... Silakan sesuaikan API URL di kode.");
        // const response = await fetch(JSON_BIN_URL, {
        //    method: 'POST',
        //    headers: {'Content-Type': 'application/json'},
        //    body: JSON.stringify(db)
        // });
    }

    function renderAll() {
        renderWarga();
        renderIPL();
        renderKas();
    }

    // --- EXPORT / IMPORT ---
    function exportExcel(tableId, filename) {
        let table = document.getElementById(tableId);
        let wb = XLSX.utils.table_to_book(table, {sheet: "Laporan"});
        XLSX.writeFile(wb, filename + ".xlsx");
    }

    function exportPDF(tableId, title) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(title, 14, 15);
        doc.autoTable({ html: '#' + tableId, startY: 20 });
        doc.save(title + ".pdf");
    }

    function importExcel(event) {
        let file = event.target.files[0];
        let reader = new FileReader();
        reader.onload = (e) => {
            let data = new Uint8Array(e.target.result);
            let workbook = XLSX.read(data, {type: 'array'});
            let sheet = workbook.Sheets[workbook.SheetNames[0]];
            let json = XLSX.utils.sheet_to_json(sheet);
            json.forEach(row => {
                db.warga.push({id: Date.now(), nama: row.Nama, alamat: row.Alamat, status: row.Status, telp: row.Kontak});
            });
            saveLocal();
            renderWarga();
        };
        reader.readAsArrayBuffer(file);
    }

    // --- CHARTS ---
    let chartW, chartK;
    function initCharts() {
        const ctxW = document.getElementById('chartWarga').getContext('2d');
        chartW = new Chart(ctxW, {
            type: 'pie',
            data: { labels: ['Tetap', 'Kontrak'], datasets: [{ data: [0, 0], backgroundColor: ['#3498db', '#e74c3c'] }] }
        });

        const ctxK = document.getElementById('chartKeuangan').getContext('2d');
        chartK = new Chart(ctxK, {
            type: 'bar',
            data: { labels: ['Pemasukan IPL', 'Pengeluaran Kas'], datasets: [{ label: 'Rupiah', data: [0, 0], backgroundColor: '#2ecc71' }] }
        });
        updateCharts();
    }

    function updateCharts() {
        const tetap = db.warga.filter(w => w.status === 'Tetap').length;
        const kontrak = db.warga.filter(w => w.status === 'Kontrak').length;
        chartW.data.datasets[0].data = [tetap, kontrak];
        chartW.update();

        const totalIPL = db.ipl.reduce((acc, curr) => acc + parseInt(curr.biaya || 0), 0);
        const totalKas = db.kas.reduce((acc, curr) => acc + parseInt(curr.jumlah || 0), 0);
        chartK.data.datasets[0].data = [totalIPL, totalKas];
        chartK.update();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
